name: Visual Regression Testing

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  pull-requests: write

jobs:
  capture:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        branch: [base, pr]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          ref: ${{ matrix.branch == 'base' && github.event.pull_request.base.ref || github.head_ref }}
          fetch-depth: 1

      - name: Capture screenshots
        uses: ./
        with:
          mode: capture
          playwright-command: npm test
          working-directory: example
          screenshot-directory: screenshots
          artifact-name: screenshots-${{ matrix.branch }}
          install-deps: true

      - name: Upload screenshots
        uses: actions/upload-artifact@v5
        with:
          name: screenshots-${{ matrix.branch }}
          path: example/screenshots/
          retention-days: 7

  compare:
    runs-on: ubuntu-latest
    needs: capture
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Download base screenshots
        uses: actions/download-artifact@v6
        with:
          name: screenshots-base
          path: screenshots-base

      - name: Download PR screenshots
        uses: actions/download-artifact@v6
        with:
          name: screenshots-pr
          path: screenshots-pr

      - name: Compare screenshots
        uses: ./
        with:
          mode: compare
          github-token: ${{ secrets.GITHUB_TOKEN }}
          base-artifact: screenshots-base
          pr-artifact: screenshots-pr
          post-comment: true
          fail-on-changes: false
          diff-threshold: '0.1'
          crop-padding: '50'
          crop-min-height: '300'
          r2-account-id: ${{ secrets.R2_ACCOUNT_ID }}
          r2-access-key-id: ${{ secrets.R2_ACCESS_KEY_ID }}
          r2-secret-access-key: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          r2-bucket-name: ${{ secrets.R2_BUCKET_NAME }}
          r2-public-url: ${{ secrets.R2_PUBLIC_URL }}
