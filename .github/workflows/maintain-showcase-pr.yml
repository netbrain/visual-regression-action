name: Maintain Showcase PR

on:
  push:
    branches:
      - main
    paths:
      - 'src/**'
      - 'Dockerfile'
      - 'action.yml'
      - 'example/**'

permissions:
  contents: write
  pull-requests: write

jobs:
  update-showcase:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup git config
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

      - name: Check if showcase branch exists
        id: check_branch
        run: |
          if git ls-remote --heads origin showcase-example | grep -q showcase-example; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "Showcase branch exists"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "Showcase branch does not exist"
          fi

      - name: Create or update showcase branch
        id: update_branch
        run: |
          if [ "${{ steps.check_branch.outputs.exists }}" = "true" ]; then
            # Fetch and checkout showcase branch
            git fetch origin showcase-example:showcase-example
            git checkout showcase-example

            # Rebase onto main to incorporate latest changes
            git rebase origin/main

            # Force push the rebased branch
            git push --force-with-lease origin showcase-example

            echo "action=updated" >> $GITHUB_OUTPUT
            echo "âœ… Showcase branch rebased onto main"
          else
            # Create new showcase branch from main
            git checkout -b showcase-example

            # Make a visual change to trigger visual regression
            echo "<!-- Showcase PR - This comment triggers visual regression -->" >> example/index.html

            git add example/index.html
            git commit -m "Add showcase visual change"

            git push origin showcase-example

            echo "action=created" >> $GITHUB_OUTPUT
            echo "âœ… Showcase branch created"
          fi

      - name: Get or create PR
        id: get_pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Check if PR already exists
          PR_NUMBER=$(gh pr list --head showcase-example --base main --json number --jq '.[0].number')

          if [ -n "$PR_NUMBER" ]; then
            echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
            echo "pr_exists=true" >> $GITHUB_OUTPUT
            echo "Found existing PR: $PR_NUMBER"
          else
            echo "pr_exists=false" >> $GITHUB_OUTPUT
            echo "No existing PR found"
          fi

      - name: Create showcase PR
        if: steps.get_pr.outputs.pr_exists == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr create \
            --title "ðŸŽ¨ Showcase: Visual Regression in Action" \
            --body "$(cat <<'EOF'
          ## ðŸ“¸ Visual Regression Showcase

          This PR demonstrates the visual-regression-action in action!

          ### What's Happening Here?

          This is a live demonstration PR that:
          - ðŸ”„ **Auto-updates** whenever action code or examples change on main
          - ðŸ“¸ **Runs visual regression** on every update
          - ðŸ’¬ **Posts comparison comments** with before/after screenshots
          - ðŸŽ¯ **Shows real diff images** with smart cropping
          - âš¡ **Demonstrates fast execution** with pre-built Docker image

          ### Try It Yourself

          To use this action in your project:

          ```yaml
          - name: Visual Regression Testing
            uses: netbrain/visual-regression-action@v1
            with:
              github-token: ${{ secrets.GITHUB_TOKEN }}
              playwright-command: npm test
              screenshot-directory: screenshots
          ```

          ### Features Demonstrated

          - âœ… Automated screenshot comparison
          - âœ… Smart diff generation with odiff
          - âœ… Intelligent cropping to highlight changes
          - âœ… PR comments with visual comparisons
          - âœ… Content-addressed artifact storage
          - âœ… Automatic screenshot commits

          ---

          **Note:** This PR is maintained automatically and will be rebased whenever the action is updated.
          It serves as a live example and should not be merged.
          EOF
          )" \
            --head showcase-example \
            --base main

          echo "âœ… Showcase PR created successfully"

      - name: Update PR description
        if: steps.get_pr.outputs.pr_exists == 'true' && steps.update_branch.outputs.action == 'updated'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER="${{ steps.get_pr.outputs.pr_number }}"

          gh pr edit $PR_NUMBER --body "$(cat <<'EOF'
          ## ðŸ“¸ Visual Regression Showcase

          This PR demonstrates the visual-regression-action in action!

          **ðŸ”„ Last updated:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')

          ### What's Happening Here?

          This is a live demonstration PR that:
          - ðŸ”„ **Auto-updates** whenever action code or examples change on main
          - ðŸ“¸ **Runs visual regression** on every update
          - ðŸ’¬ **Posts comparison comments** with before/after screenshots
          - ðŸŽ¯ **Shows real diff images** with smart cropping
          - âš¡ **Demonstrates fast execution** with pre-built Docker image

          ### Try It Yourself

          To use this action in your project:

          ```yaml
          - name: Visual Regression Testing
            uses: netbrain/visual-regression-action@v1
            with:
              github-token: ${{ secrets.GITHUB_TOKEN }}
              playwright-command: npm test
              screenshot-directory: screenshots
          ```

          ### Features Demonstrated

          - âœ… Automated screenshot comparison
          - âœ… Smart diff generation with odiff
          - âœ… Intelligent cropping to highlight changes
          - âœ… PR comments with visual comparisons
          - âœ… Content-addressed artifact storage
          - âœ… Automatic screenshot commits

          ---

          **Note:** This PR is maintained automatically and will be rebased whenever the action is updated.
          It serves as a live example and should not be merged.
          EOF
          )"

          echo "âœ… Showcase PR description updated"
