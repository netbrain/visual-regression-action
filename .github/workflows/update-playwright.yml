name: Update Playwright Version

on:
  schedule:
    # Check for updates every Monday at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  check-update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install skopeo
        run: |
          sudo apt-get update
          sudo apt-get install -y skopeo

      - name: Get latest Playwright version and digest
        id: playwright
        run: |
          # Get latest Playwright version from npm
          LATEST_VERSION=$(npm view playwright version)
          echo "latest_version=$LATEST_VERSION" >> $GITHUB_OUTPUT
          echo "Latest Playwright version: $LATEST_VERSION"

          # Get digest for latest version
          LATEST_DIGEST=$(skopeo inspect docker://mcr.microsoft.com/playwright:v${LATEST_VERSION}-noble | jq -r '.Digest')
          echo "latest_digest=$LATEST_DIGEST" >> $GITHUB_OUTPUT
          echo "Latest digest: $LATEST_DIGEST"

          # Get current digest from Dockerfile
          CURRENT_DIGEST=$(grep -oP 'mcr.microsoft.com/playwright@sha256:\K[a-f0-9]{64}' Dockerfile || echo "none")
          echo "current_digest=$CURRENT_DIGEST" >> $GITHUB_OUTPUT
          echo "Current digest: $CURRENT_DIGEST"

          # Get current version from comment
          CURRENT_VERSION=$(grep -oP '# Playwright v\K[0-9]+\.[0-9]+\.[0-9]+' Dockerfile || echo "unknown")
          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "Current version: $CURRENT_VERSION"

          # Check if update is needed (compare digests)
          if [ "$CURRENT_DIGEST" != "${LATEST_DIGEST#sha256:}" ]; then
            echo "needs_update=true" >> $GITHUB_OUTPUT
            echo "Update needed: $CURRENT_VERSION ($CURRENT_DIGEST) -> $LATEST_VERSION (${LATEST_DIGEST#sha256:})"
          else
            echo "needs_update=false" >> $GITHUB_OUTPUT
            echo "Already on latest version"
          fi

      - name: Update Dockerfile
        if: steps.playwright.outputs.needs_update == 'true'
        run: |
          LATEST_VERSION="${{ steps.playwright.outputs.latest_version }}"
          LATEST_DIGEST="${{ steps.playwright.outputs.latest_digest }}"

          # Update the comment and FROM line in Dockerfile
          sed -i "s|# Playwright v.*|# Playwright v${LATEST_VERSION}-noble|g" Dockerfile
          sed -i "s|FROM mcr.microsoft.com/playwright@sha256:.*|FROM mcr.microsoft.com/playwright@${LATEST_DIGEST}|g" Dockerfile

          echo "Updated Dockerfile to use Playwright v${LATEST_VERSION} with digest ${LATEST_DIGEST}"

      - name: Commit and push changes
        if: steps.playwright.outputs.needs_update == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          git add Dockerfile
          git commit -m "chore: update Playwright to v${{ steps.playwright.outputs.latest_version }}

          Updated Playwright Docker image from v${{ steps.playwright.outputs.current_version }} to v${{ steps.playwright.outputs.latest_version }}

          - Old digest: sha256:${{ steps.playwright.outputs.current_digest }}
          - New digest: ${{ steps.playwright.outputs.latest_digest }}

          Release notes: https://github.com/microsoft/playwright/releases/tag/v${{ steps.playwright.outputs.latest_version }}"

          git push origin main
