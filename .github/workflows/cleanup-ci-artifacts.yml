name: Cleanup CI Artifacts Branch

# WHY THIS WORKFLOW EXISTS:
# The _ci branch stores diff images for PR comments. We can't use GitHub Actions
# artifacts for this because:
# 1. Artifacts require authentication - can't be embedded in public PR comments
# 2. Artifact URLs expire after 1 hour
# 3. GitHub removed public artifact access in 2020
# 4. raw.githubusercontent.com URLs are the ONLY way to show images in PR comments
#
# This workflow prevents unbounded _ci branch growth by:
# - Deleting images older than 30 days
# - Squashing all commits to keep git history small

on:
  schedule:
    - cron: '0 0 * * 0'  # Weekly cleanup on Sundays at midnight UTC
  workflow_dispatch:
    inputs:
      retention_days:
        description: 'Number of days to retain artifacts (default: 30)'
        required: false
        default: '30'
        type: number

permissions:
  contents: write

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout _ci branch
        uses: actions/checkout@v4
        with:
          ref: _ci
          fetch-depth: 0

      - name: Setup git config
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

      - name: Clean up artifacts older than retention period
        id: cleanup
        run: |
          RETENTION_DAYS="${{ github.event.inputs.retention_days || '30' }}"
          echo "Retention period: $RETENTION_DAYS days"

          CUTOFF_DATE=$(date -d "$RETENTION_DAYS days ago" +%s)
          echo "Cutoff date: $(date -d '@$CUTOFF_DATE' '+%Y-%m-%d %H:%M:%S')"

          TOTAL_FILES=0
          DELETED_FILES=0

          echo "Analyzing files in _ci branch..."

          for FILE in *.png; do
            if [ ! -f "$FILE" ]; then
              continue
            fi

            TOTAL_FILES=$((TOTAL_FILES + 1))

            COMMIT_DATE=$(git log -1 --format=%ct -- "$FILE")

            if [ -z "$COMMIT_DATE" ]; then
              echo "Warning: Could not get commit date for $FILE, skipping"
              continue
            fi

            if [ "$COMMIT_DATE" -lt "$CUTOFF_DATE" ]; then
              DELETED_FILES=$((DELETED_FILES + 1))
              echo "Deleting old artifact: $FILE ($(date -d "@$COMMIT_DATE" '+%Y-%m-%d'))"
              git rm "$FILE"
            fi
          done

          echo ""
          echo "=== Cleanup Summary ==="
          echo "Total artifacts: $TOTAL_FILES"
          echo "Deleted artifacts: $DELETED_FILES"
          echo "Remaining artifacts: $((TOTAL_FILES - DELETED_FILES))"

          echo "TOTAL_FILES=$TOTAL_FILES" >> $GITHUB_ENV
          echo "DELETED_FILES=$DELETED_FILES" >> $GITHUB_ENV
          echo "REMAINING_FILES=$((TOTAL_FILES - DELETED_FILES))" >> $GITHUB_ENV
          echo "CUTOFF_DATE=$(date -d '@$CUTOFF_DATE' '+%Y-%m-%d')" >> $GITHUB_ENV
          echo "RETENTION_DAYS=$RETENTION_DAYS" >> $GITHUB_ENV

          if [ "$DELETED_FILES" -gt 0 ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Squash all commits into one and push
        if: steps.cleanup.outputs.has_changes == 'true'
        run: |
          git add -A

          COMMIT_COUNT=$(git rev-list --count HEAD)
          echo "Current commits in branch: $COMMIT_COUNT"
          echo "Squashing $COMMIT_COUNT commits into one..."

          TEMP_BRANCH="_ci-squashed-temp"
          git checkout --orphan "$TEMP_BRANCH"

          git add -A

          git commit \
            -m "_ci cleanup" \
            -m "Automated weekly maintenance of visual regression artifacts." \
            -m "" \
            -m "Cleanup summary:" \
            -m "- Total artifacts before: $TOTAL_FILES" \
            -m "- Artifacts deleted (>$RETENTION_DAYS days): $DELETED_FILES" \
            -m "- Remaining artifacts: $REMAINING_FILES" \
            -m "- Cutoff date: $CUTOFF_DATE" \
            -m "- Retention period: $RETENTION_DAYS days" \
            -m "" \
            -m "This branch stores diff images from visual regression tests." \
            -m "Images are content-addressed using SHA256 hashing for deduplication."

          echo "Force pushing squashed commit to _ci branch..."
          git push -f origin HEAD:_ci

          echo "✅ Cleanup complete!"
          echo "   - Deleted: $DELETED_FILES files"
          echo "   - Remaining: $REMAINING_FILES files"
          echo "   - Commits squashed: $COMMIT_COUNT → 1"

      - name: No changes needed
        if: steps.cleanup.outputs.has_changes == 'false'
        run: |
          echo "✅ No old artifacts to clean up - _ci branch is already clean!"
